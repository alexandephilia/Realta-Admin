<!DOCTYPE html>
<h4 class="mb-3 text-body mb-0">Content Section</h4>
<div class="card">
    <div class="card-body">
        <div class="text-end">
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createContentModal">
                <span class="fas fa-plus me-2"></span>Add New Content
            </button>
        </div>

        <!-- Create Content Modal -->
        <div class="modal fade" id="createContentModal" tabindex="-1" aria-labelledby="createContentModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="modal-title" id="createContentModalLabel">
                            <i class=" me-2"></i>Create New Section
                        </h5>
                        <div class="d-flex align-items-center">
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <form id="createContentForm">
                            <div class="row g-3">
                                <!-- Left Column -->
                                <div class="col-12 col-lg-4">
                                    <!-- Basic Information Card -->
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Configuration</h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- Section Details -->
                                            <div class="mb-4">
                                                <h6 class="mb-3">Section Details</h6>
                                                <div class="mb-3">
                                                    <label class="form-label fw-semibold" for="sectionName">Section
                                                        Name</label>
                                                    <input type="text" class="form-control" id="sectionName"
                                                        placeholder="e.g. Header, Footer, CTA">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-semibold"
                                                        for="micrositeName">Microsite</label>
                                                    <select class="form-select" id="micrositeName">
                                                        <option value="">Select Microsite</option>
                                                        <option value="bimasakti">Bimasakti</option>
                                                        <option value="rhapsody">Rhapsody</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Display Settings -->
                                            <div class="mb-4">
                                                <h6 class="mb-3">Display Settings</h6>
                                                <div class="mb-3">
                                                    <label class="form-label fw-semibold">Display Order</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i
                                                                class="fas fa-sort-numeric-down"></i></span>
                                                        <input type="number" class="form-control" id="sectionOrder"
                                                            min="1" value="1">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-end pe-4">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox"
                                                            id="contentStatus" checked>
                                                        <label class="form-check-label ms-2" for="contentStatus">
                                                            Status: <span class="text-success status-text">Active</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column -->
                                <div class="col-12 col-lg-8">
                                    <!-- Content Card -->
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Content & Styling</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label fw-semibold" for="sectionContent">HTML
                                                    Content</label>
                                                <textarea class="tinymce-editor" id="sectionContent"></textarea>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold" for="sectionStyles">CSS
                                                        Styles</label>
                                                    <textarea class="form-control font-monospace code-editor"
                                                        id="sectionStyles" rows="4"
                                                        placeholder="Enter custom CSS styles"></textarea>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold"
                                                        for="sectionScript">JavaScript</label>
                                                    <textarea class="form-control font-monospace code-editor"
                                                        id="sectionScript" rows="4"
                                                        placeholder="Enter custom JavaScript"></textarea>
                                                    <div class="text-end mt-2">
                                                        <button type="button" class="btn btn-falcon-default btn-sm"
                                                            onclick="showPreviewModal()">
                                                            <span class="fas fa-eye me-1"></span>Preview
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class=" me-1"></i>Cancel
                        </button>
                        <button type="submit" form="createContentForm" class="btn btn-primary">
                            <i class=" me-1"></i>Create Section
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="table-responsive mt-4">
            <table class="table table-hover" id="contentTable">
                <thead>
                    <tr>
                        <th class="text-center">Ordering</th>
                        <th class="text-center">Section Name</th>
                        <th class="text-center">Microsite</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-center">
                            <button class="btn px-1 btn-sm btn-falcon-default me-1">
                                <span class="fas fa-chevron-up"></span>
                            </button>
                            <button class="btn px-1 btn-sm btn-falcon-default">
                                <span class="fas fa-chevron-down"></span>
                            </button>
                        </td>
                        <td class="text-center">CTA</td>
                        <td class="text-center">Bimasakti</td>
                        <td class="text-center">
                            <span class="badge badge-phoenix fs-10 badge-phoenix-success">
                                <span class="fa fa-check"></span>
                            </span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-falcon-default text-danger" data-bs-toggle="modal"
                                data-bs-target="#deleteContentModal">
                                <span class="fas fa-trash-alt"></span>
                            </button>
                            <button class="btn btn-sm btn-falcon-default text-warning">
                                <span class="fas fa-edit me-2"></span>Edit
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-center">
                            <button class="btn px-1 btn-sm btn-falcon-default me-1">
                                <span class="fas fa-chevron-up"></span>
                            </button>
                            <button class="btn px-1 btn-sm btn-falcon-default">
                                <span class="fas fa-chevron-down"></span>
                            </button>
                        </td>
                        <td class="text-center">Header</td>
                        <td class="text-center">Rhapsody</td>
                        <td class="text-center">
                            <span class="badge badge-phoenix fs-10 badge-phoenix-danger">
                                <span class="fa fa-xmark"></span>
                            </span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-falcon-default text-danger" data-bs-toggle="modal"
                                data-bs-target="#deleteContentModal">
                                <span class="fas fa-trash-alt"></span>
                            </button>
                            <button class="btn btn-sm btn-falcon-default text-warning">
                                <span class="fas fa-edit me-2"></span>Edit
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Delete Content Modal -->
        <div class="modal fade" id="deleteContentModal" tabindex="-1" aria-labelledby="deleteContentModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteContentModalLabel">Delete Content</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this content section? This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#">Previous</a>
                </li>
                <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">2</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>

        <!-- Preview Modal -->
        <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="previewModalLabel">Live Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="previewContent" class="border rounded p-3" style="min-height: 300px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-falcon-default btn-sm" onclick="refreshPreview()">
                            <span class="fas fa-sync-alt me-1"></span>Refresh Preview
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Initialize TinyMCE
            function initializeTinyMCE() {
                tinymce.init({
                    selector: '.tinymce-editor',
                    height: 400,
                    menubar: false,
                    branding: false,
                    statusbar: false,
                    elementpath: false,
                    resize: false,
                    plugins: [
                        'lists', 'link', 'image', 'code', 'table', 'help', 'indent'
                    ],
                    toolbar: 'styles | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist | link image | code removeformat',
                    indent_use_margin: false,
                    content_style: `
                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }
                p { margin: 0 0 1em; }
                .tox-statusbar { display: none !important; }
            `,
                    hidden_input: false,
                    inline: false,
                    setup: function (editor) {
                        editor.on('init', function () {
                            // Store the editor instance for later use
                            window.currentTinyMCEEditor = editor;

                            // Initial setup of custom style element
                            const editorIframe = editor.iframeElement;
                            const editorDocument = editorIframe.contentDocument;
                            let customStyleElement = editorDocument.getElementById('custom-styles');
                            if (!customStyleElement) {
                                customStyleElement = editorDocument.createElement('style');
                                customStyleElement.id = 'custom-styles';
                                editorDocument.head.appendChild(customStyleElement);
                            }

                            // Initial setup of custom script element
                            let customScriptElement = editorDocument.getElementById(
                                'custom-scripts');
                            if (!customScriptElement) {
                                customScriptElement = editorDocument.createElement('script');
                                customScriptElement.id = 'custom-scripts';
                                editorDocument.body.appendChild(customScriptElement);
                            }
                        });

                        // Override default source code button behavior
                        editor.ui.registry.addButton('code', {
                            icon: 'sourcecode',
                            tooltip: 'Source code',
                            onAction: function () {
                                showTinyMCESource(editor);
                            }
                        });

                        editor.on('init', function () {
                            const editorContainer = editor.getContainer();
                            const customStyles = document.createElement('style');
                            customStyles.textContent = `
                        .tox-toolbar__group:has(.tox-tbtn--select) {
                            width: auto !important;
                            flex: 0 0 auto !important;
                        }
                        .tox-tbtn.tox-tbtn--select {
                            width: 200px !important;
                            min-width: 200px !important;
                        }
                        .tox-tbtn__select-label {
                            width: auto !important;
                            flex-grow: 1 !important;
                        }
                        .tox-statusbar,
                        .tox-statusbar__path,
                        .tox-statusbar__text-container,
                        .tox-statusbar__branding {
                            display: none !important;
                        }
                    `;
                            editorContainer.appendChild(customStyles);
                        });
                    }
                });
            }

            // Function to show source code modal
            function showTinyMCESource(editor) {
                const sourceCode = editor.getContent();
                const formattedCode = formatHTML(sourceCode);
                document.getElementById('tinyMCESourceCode').value = formattedCode;

                const currentModal = document.querySelector('.modal.show');
                const sourceCodeModal = document.getElementById('tinyMCESourceModal');

                if (currentModal) {
                    const currentZIndex = parseInt(getComputedStyle(currentModal).zIndex);
                    sourceCodeModal.style.zIndex = currentZIndex + 2;

                    const modal = new bootstrap.Modal(sourceCodeModal, {
                        backdrop: 'static',
                        keyboard: false
                    });
                    modal.show();

                    setTimeout(() => {
                        const backdrop = document.querySelector('.modal-backdrop:last-child');
                        if (backdrop) {
                            backdrop.style.zIndex = currentZIndex + 1;
                            backdrop.style.opacity = '0.5';
                        }
                    }, 0);

                    sourceCodeModal.addEventListener('hidden.bs.modal', function handler() {
                        sourceCodeModal.style.zIndex = '';
                        this.removeEventListener('hidden.bs.modal', handler);
                    });
                } else {
                    const modal = new bootstrap.Modal(sourceCodeModal, {
                        backdrop: 'static',
                        keyboard: false
                    });
                    modal.show();
                }
            }

            // Function to format HTML with proper indentation
            function formatHTML(html) {
                let formatted = '';
                let indent = '';
                const tab = '  '; // 2 spaces for indentation

                html.split(/>\s*</).forEach(function (element) {
                    if (element.match(/^\/\w/)) {
                        indent = indent.substring(tab.length);
                    }

                    formatted += indent + '<' + element + '>\r\n';

                    if (element.match(/^<?\w[^>]*[^\/]$/) && !element.startsWith("input") && !element
                        .startsWith("img")) {
                        indent += tab;
                    }
                });

                return formatted.substring(1, formatted.length - 3);
            }

            // Function to apply source code changes
            function applySourceCode() {
                const sourceCode = document.getElementById('tinyMCESourceCode').value;
                const editor = tinymce.activeEditor;
                if (editor) {
                    editor.setContent(sourceCode);
                    bootstrap.Modal.getInstance(document.getElementById('tinyMCESourceModal')).hide();
                }
            }

            // Function to copy source code
            function copyTinyMCESource() {
                const sourceCode = document.getElementById('tinyMCESourceCode');
                sourceCode.select();

                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(sourceCode.value);
                    } else {
                        document.execCommand('copy');
                    }

                    const copyBtn = event.currentTarget;
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<span class="fas fa-check me-1"></span>Copied!';
                    copyBtn.classList.add('btn-success');

                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.classList.remove('btn-success');
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = sourceCode.value;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                }
            }

            // Function to update preview with CSS changes
            function updateCSSPreview() {
                const cssContent = document.getElementById('sectionStyles').value;
                const editor = window.currentTinyMCEEditor;

                if (editor) {
                    const editorIframe = editor.iframeElement;
                    const editorDocument = editorIframe.contentDocument;
                    let customStyleElement = editorDocument.getElementById('custom-styles');

                    if (customStyleElement) {
                        customStyleElement.textContent = cssContent;
                    }
                }
            }

            // Function to update preview with JS changes
            function updateJSPreview() {
                const jsContent = document.getElementById('sectionScript').value;
                const editor = window.currentTinyMCEEditor;

                if (editor) {
                    const editorIframe = editor.iframeElement;
                    const editorDocument = editorIframe.contentDocument;
                    let customScriptElement = editorDocument.getElementById('custom-scripts');

                    if (customScriptElement) {
                        // Remove old script
                        customScriptElement.remove();

                        // Create new script element
                        customScriptElement = editorDocument.createElement('script');
                        customScriptElement.id = 'custom-scripts';
                        customScriptElement.textContent = jsContent;
                        editorDocument.body.appendChild(customScriptElement);
                    }
                }
            }

            // Add event listeners when modal is shown
            $('#createContentModal').on('shown.bs.modal', function () {
                tinymce.remove('.tinymce-editor'); // Remove existing instances first
                initializeTinyMCE();

                // Add real-time preview listeners
                const cssEditor = document.getElementById('sectionStyles');
                const jsEditor = document.getElementById('sectionScript');

                cssEditor.addEventListener('input', updateCSSPreview);
                jsEditor.addEventListener('input', updateJSPreview);
            });

            // Clean up when modal is hidden
            $('#createContentModal').on('hidden.bs.modal', function () {
                const cssEditor = document.getElementById('sectionStyles');
                const jsEditor = document.getElementById('sectionScript');

                cssEditor.removeEventListener('input', updateCSSPreview);
                jsEditor.removeEventListener('input', updateJSPreview);

                tinymce.remove('.tinymce-editor');
            });

            // Handle content status toggle
            document.getElementById('contentStatus').addEventListener('change', function () {
                const statusText = this.closest('.form-check').querySelector('.status-text');
                if (this.checked) {
                    statusText.textContent = 'Active';
                    statusText.classList.remove('text-danger');
                    statusText.classList.add('text-success');
                } else {
                    statusText.textContent = 'Inactive';
                    statusText.classList.remove('text-success');
                    statusText.classList.add('text-danger');
                }
            });

            // Function to show preview modal
            function showPreviewModal() {
                const editor = window.currentTinyMCEEditor;
                if (editor) {
                    const content = editor.getContent();
                    const css = document.getElementById('sectionStyles').value;
                    const js = document.getElementById('sectionScript').value;

                    // Get the preview modal
                    const previewModal = document.getElementById('previewModal');
                    const currentModal = document.querySelector('.modal.show');

                    // Set z-index to be higher than the current modal
                    if (currentModal) {
                        const currentZIndex = parseInt(getComputedStyle(currentModal).zIndex);
                        previewModal.style.zIndex = currentZIndex + 2;
                    }

                    // Create preview content
                    const previewContent = document.getElementById('previewContent');
                    previewContent.innerHTML = `
                <style>${css}</style>
                ${content}
                <script>${js}<\/script>
            `;

                    // Show the modal
                    const modal = new bootstrap.Modal(previewModal);
                    modal.show();

                    // Adjust backdrop z-index
                    setTimeout(() => {
                        const backdrop = document.querySelector('.modal-backdrop:last-child');
                        if (backdrop && currentModal) {
                            const currentZIndex = parseInt(getComputedStyle(currentModal).zIndex);
                            backdrop.style.zIndex = currentZIndex + 1;
                        }
                    }, 0);
                }
            }

            // Function to refresh preview
            function refreshPreview() {
                const editor = window.currentTinyMCEEditor;
                if (editor) {
                    const content = editor.getContent();
                    const css = document.getElementById('sectionStyles').value;
                    const js = document.getElementById('sectionScript').value;

                    const previewContent = document.getElementById('previewContent');
                    previewContent.innerHTML = `
                <style>${css}</style>
                ${content}
                <script>${js}<\/script>
            `;
                }
            }
        </script>

        <!-- TinyMCE Source Code Modal -->
        <div class="modal fade" id="tinyMCESourceModal" tabindex="-1" aria-labelledby="tinyMCESourceModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="tinyMCESourceModalLabel">HTML Source Code</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <textarea class="form-control font-monospace" id="tinyMCESourceCode" rows="20"
                                style="tab-size: 2;"></textarea>
                        </div>
                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-falcon-default btn-sm" onclick="applySourceCode()">
                                <span class="fas fa-check me-1"></span>Apply Changes
                            </button>
                            <button type="button" class="btn btn-falcon-default btn-sm ms-2"
                                onclick="copyTinyMCESource()">
                                <span class="fas fa-copy me-1"></span>Copy Code
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>